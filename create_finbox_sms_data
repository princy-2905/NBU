--staging table create query

Drop table stg_finbox_sms_data;
create  table  stg_finbox_sms_data (

customer_id varchar(30)  ENCODE lzo ,   

request_id varchar(50)  ENCODE lzo ,

date_requested TIMESTAMP  ENCODE lzo,

data varchar(MAX)  ENCODE lzo 

)

--  load data into staging table

COPY  stg_finbox_sms_data FROM  's3://angelone-nbu/finbox/'
IAM_ROLE 'arn:aws:iam::555445901246:role/analytics-redshift-glue-role'
JSON 'auto'
TIMEFORMAT 'auto';

-- load data into main table


insert into finbox_sms_data
Select
CAST(customer_id as varchar(50)),
CAST(request_id as varchar(50)),
GETDATE() as inserted_at,
GETDATE() as updated_at,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 0) , 'value') as varchar(50)) as insurance_flag,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 1) , 'value') as integer) as cnt_insurance_accounts,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 2) , 'value') as decimal(10,2)) as amt_insurance_accounts_c180,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 3) , 'value') as  decimal(10,2)) as amt_insurance_accounts_last_6mo,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 4) , 'value') as integer) as insurance_trx_recency,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 5) , 'value') as varchar(50)) as  mf_flag,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 6) , 'value') as  decimal(10,2)) as amt_mf_portfolio,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 7) , 'value') as integer)mf_trx_recency,
CAST(JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 8) , 'value') as decimal(10,2))amt_mf_accounts_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 9) , 'value') amt_mf_accounts_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 10) , 'value') investor_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 11) , 'value') equity_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 12) , 'value') investor1_name,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 13) , 'value') investor2_name,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 14) , 'value') total_amt_equity_portfolio_latest,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 15) , 'value') cnt_equity_trx_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 16) , 'value') max_amt_equity_portfolio,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 17) , 'value') total_amt_ledger_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 18) , 'value') amt_fd_accounts_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 19) , 'value') cnt_fd_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 20) , 'value') mf_trx_latest_date,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 21) , 'value') loan_disbursed_latest_date,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 22) , 'value') insurance_trx_latest_date,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 23) , 'value') trade_trx_latest_date,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 24) , 'value') credit_card_user_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 25) , 'value') max_cc_limit,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 26) , 'value') cnt_cc_acc,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 27) , 'value') max_preapproved_cc_limit,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 28) , 'value') cc_bill_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 29) , 'value') cc_bill_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 30) , 'value') max_cc_bill_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 31) , 'value') max_cc_bill_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 32) , 'value') cc1_bank,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 33) , 'value') cnt_cc_applications_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 34) , 'value') cc_utilisation,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 35) , 'value') cc_latest_bill_date,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 36) , 'value') cnt_loan_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 37) , 'value') cnt_personal_loan,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 38) , 'value') cnt_apps_sub_genre_lending_v2,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 39) , 'value') cnt_active_loan_accounts_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 40) , 'value') max_disbursed_amt_active_loan_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 41) , 'value') cnt_closed_loan_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 42) , 'value') max_disbursed_amt_closed_loan_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 43) , 'value') cnt_loan_disbursed_gt_100k,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 44) , 'value') cnt_active_loan_disbursed_gt_100k,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 45) , 'value') max_dpd_all_acc,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 46) , 'value') max_amt_delinquncy_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 47) , 'value') cnt_loan_disbursed_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 48) , 'value') cnt_loan_rejected_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 49) , 'value') cnt_loan_applications_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 50) , 'value') total_emi_loan_all_acc_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 51) , 'value') total_emi_loan_all_acc_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 52) , 'value') max_emi_loan_all_acc_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 53) , 'value') max_emi_loan_all_acc_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 54) , 'value') avg_emi_loan_all_acc_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 55) , 'value') avg_emi_loan_all_acc_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 56) , 'value') total_emi_loan_all_acc_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 57) , 'value') max_emi_loan_all_acc_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 58) , 'value') max_preapproved_bnpl_limit_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 59) , 'value') max_bal_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 60) , 'value') max_bal_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 61) , 'value') avg_bal_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 62) , 'value') avg_bal_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 63) , 'value') max_amt_credit_txn_last_3mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 64) , 'value') max_amt_credit_txn_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 65) , 'value') max_amt_debit_txn_last_3mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 66) , 'value') max_amt_debit_txn_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 67) , 'value') amt_credit_txn_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 68) , 'value') amt_debit_txn_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 69) , 'value') cnt_credit_100k_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 70) , 'value') cnt_debit_100k_last_6mo,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 71) , 'value') sum_acc_latest_balance_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 72) , 'value') min_bal_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 73) , 'value') max_bal_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 74) , 'value') avg_bal_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 75) , 'value') cnt_credit_txn_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 76) , 'value') cnt_debit_txn_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 77) , 'value') cnt_credit_txn_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 78) , 'value') cnt_debit_txn_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 79) , 'value') cnt_credit_txn_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 80) , 'value') cnt_debit_txn_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 81) , 'value') cnt_savings_accounts,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 82) , 'value') obligations,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 83) , 'value') avg_total_income_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 84) , 'value') calculated_income_amount_confidence_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 85) , 'value') calculated_income_amount_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 86) , 'value') salaried_flag_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 87) , 'value') salary_date_m0_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 88) , 'value') salary_date_m1_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 89) , 'value') salary_date_m2_v3,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 90) , 'value') fd_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 91) , 'value') rd_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 92) , 'value') po_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 93) , 'value') all_sms_count,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 94) , 'value') sms_vintage,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 95) , 'value') sms_recency,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 96) , 'value') transactional_sms_count,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 97) , 'value') cnt_apps_fake_gps_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 98) , 'value') concentration_device,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 99) , 'value') concentration_location,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 100) , 'value') concentration_ip_address,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 101) , 'value') cnt_ewallets_used,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 102) , 'value') cnt_apps_root_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 103) , 'value') all_connected_devices,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 104) , 'value') cnt_fraud_assists_apps,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 105) , 'value') fraud_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 106) , 'value') bounce_flag,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 107) , 'value') auto_debit_bounce_m0,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 108) , 'value') auto_debit_bounce_m1,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 109) , 'value') cheque_bounce_c30,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 110) , 'value') cnt_overdue_sms_c90,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 111) , 'value') cnt_loan_writtenoff_c180,
JSON_EXTRACT_PATH_TEXT(JSON_EXTRACT_ARRAY_ELEMENT_TEXT(data, 112) , 'value') data_sufficiency_flag
 from stg_finbox_sms_data;

